<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Desafio do Luiz ü§ì</title>
<style>
  :root {
    --bg1: #0a192f;
    --accent: #00bfff;
    --good: #00ff99;
    --warn: #ffeb3b;
    --bad: #ff4444;
    --font: "Poppins", sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: radial-gradient(circle at center, var(--bg1), #000);
    color: #fff;
    font-family: var(--font);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
  }

  .app {
    width: 95%;
    max-width: 960px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  /* Luiz */
  .luiz-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
    min-height: 200px;
  }

  .balon {
    background: rgba(255,255,255,.1);
    padding: 14px 18px;
    border-radius: 22px;
    font-style: italic;
    max-width: 720px;
    min-height: 48px;
    font-size: 1.1rem;
    transition: all .4s ease;
    opacity: 0;
    transform: scale(0.8);
  }

  .balon.show {
    opacity: 1;
    transform: scale(1);
  }

  .luiz {
    font-size: 4rem;
    margin-top: 8px;
    transition: transform 0.3s ease, filter 0.3s ease, opacity .3s;
  }

  input, button {
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    margin-top: 10px;
    font-size: 1rem;
    font-family: var(--font);
  }

  input { width: 240px; text-align: center; }

  button {
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    transition: 0.2s;
  }

  button:hover, button:focus { filter: brightness(1.2); }

  .timer-bar {
    width: 280px;
    height: 12px;
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    margin-top: 10px;
    overflow: hidden;
  }

  #tempo-barra {
    height: 100%;
    background: linear-gradient(90deg, var(--good), var(--warn), var(--bad));
    width: 100%;
    transition: width 0.1s linear;
  }

  .meta {
    font-size: 1rem;
    margin-top: 12px;
  }

  /* Rea√ß√µes */
  .anim-feliz { transform: scale(1.1); filter: drop-shadow(0 0 8px var(--good)); }
  .anim-irritado { transform: scale(1.1) rotate(-5deg); filter: drop-shadow(0 0 6px var(--bad)); }
  .anim-triste { transform: scale(0.9); opacity: 0.8; }
  .anim-curioso { transform: scale(1.05); filter: brightness(1.3); }
  .anim-expectativa { animation: balanco 2s infinite ease-in-out; }

  @keyframes balanco {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  @media (max-width:600px) {
    .luiz { font-size: 3rem; }
    .balon { font-size: 0.95rem; }
  }

  .tremer { animation: tremer 0.3s infinite alternate; }
  @keyframes tremer { 0% { transform: translateX(-2px); } 100% { transform: translateX(2px); } }

  /* üëÅÔ∏è Piscadas autom√°ticas */
  @keyframes piscar {
    0%, 90%, 100% { opacity: 1; transform: scaleY(1); }
    95% { opacity: 0.3; transform: scaleY(0.2); }
  }
  .piscando { animation: piscar 4s infinite; }

  /* ü©∏ Estilo modo pesadelo */
  .alerta-pesadelo {
    background: rgba(255,0,0,0.1);
    border: 1px solid #ff4444;
    border-radius: 12px;
    padding: 16px;
    margin-top: 12px;
  }
  .botao-pesadelo {
    background: #ff0000;
    color: #fff;
    padding: 10px 16px;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;
    transition: 0.3s;
  }
  .botao-pesadelo:hover { filter: brightness(1.3); }
</style>
</head>
<body>
  <div class="app">
    <div id="luiz" class="luiz-container">
      <div id="fala-luiz" class="balon show">Oi! Eu sou o Luiz ü§ì<br>Qual √© o seu nome?</div>
      <div id="expressao-luiz" class="luiz piscando">ü§ì</div>
    </div>

    <!-- Tela inicial -->
    <div id="tela-nome">
      <input id="nome" type="text" placeholder="Digite seu nome..." autofocus />
      <button id="btn-iniciar">Come√ßar</button>
    </div>

    <!-- Tela do jogo -->
    <div id="tela-jogo" style="display:none;flex-direction:column;align-items:center;">
      <h2 id="pergunta" style="transition:opacity .3s;"></h2>
      <input id="resposta" placeholder="Digite sua resposta..." />
      <button id="btn-responder">Enviar</button>

      <div class="timer-bar"><div id="tempo-barra"></div></div>
      <div id="tempo-texto">‚è≥ 30s</div>

      <div class="meta">
        Pontua√ß√£o: <span id="pontos">0</span> ¬∑ N√≠vel: <span id="nivel">1</span>
      </div>

      <!-- ‚ö°Ô∏è Aqui entra o painel do modo pesadelo -->
      <div id="pesadelo-container"></div>
    </div>

    <!-- Tela de fim -->
    <div id="tela-gameover" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,.85);">
      <div style="background:rgba(255,255,255,.06);padding:20px;border-radius:12px;text-align:center;">
        <h1 id="titulo-fim">üí• Voc√™ Perdeu!</h1>
        <p id="texto-fim"></p>
        <div id="ranking"></div>
        <button id="btn-reiniciar">Reiniciar</button>
      </div>
    </div>
  </div>

<script>
let tempoRestante = 30;
let tempoBase = 30;
let temporizador;
let jogoAtivo = false;
let modoPesadelo = false;
let perguntaAtual = "";
let nivelAtual = 1;
let pontuacaoAtual = 0;
let tempoUltimaAtividade = Date.now();
let humorTimer;

const falaLuiz = document.getElementById("fala-luiz");
const expressaoLuiz = document.getElementById("expressao-luiz");
const nomeJogador = document.getElementById("nome");
const campoResposta = document.getElementById("resposta");
const botaoResponder = document.getElementById("btn-responder");
const tempoBarra = document.getElementById("tempo-barra");
const tempoTexto = document.getElementById("tempo-texto");
const pontosDisplay = document.getElementById("pontos");
const nivelDisplay = document.getElementById("nivel");
const telaNome = document.getElementById("tela-nome");
const telaJogo = document.getElementById("tela-jogo");
const telaGameover = document.getElementById("tela-gameover");
const perguntaEl = document.getElementById("pergunta");

function animarLuiz(tipo, expressao = null) {
  expressaoLuiz.classList.remove("anim-feliz","anim-irritado","anim-triste","anim-curioso","anim-expectativa","tremer");
  void expressaoLuiz.offsetWidth;
  expressaoLuiz.classList.add(tipo);
  if (expressao) expressaoLuiz.textContent = expressao;
  setTimeout(() => expressaoLuiz.classList.remove(tipo), 1200);
}

function falar(texto) {
  falaLuiz.classList.remove("show");
  setTimeout(() => {
    falaLuiz.innerHTML = texto;
    falaLuiz.classList.add("show");
  }, 200);
}

async function iniciarJogo() {
  const nome = nomeJogador.value.trim() || "Jogador";
  const formData = new FormData();
  formData.append("nome", nome);

  const res = await fetch("/iniciar", { method: "POST", body: formData });
  const data = await res.json();

  jogoAtivo = true;
  modoPesadelo = false;
  nivelAtual = data.nivel || 1;
  pontuacaoAtual = data.pontos || 0;
  perguntaAtual = data.pergunta;

  tempoBase = 30;
  tempoRestante = tempoBase;

  telaNome.style.display = "none";
  telaJogo.style.display = "flex";

  falar("Preparado, " + nome + "? Vamos come√ßar!");
  expressaoLuiz.textContent = "ü§ì";

  mostrarPergunta(perguntaAtual);
  iniciarTemporizador();
  iniciarHumorLuiz();
}

function iniciarTemporizador() {
  clearInterval(temporizador);
  atualizarTempo();
  temporizador = setInterval(() => {
    if (!jogoAtivo) return;
    tempoRestante -= 0.1;
    atualizarTempo();
    if (tempoRestante <= 0)
      fimDeJogo("‚è∞ O tempo acabou! Luiz venceu!", pontuacaoAtual, "üòà");
  }, 100);
}

function atualizarTempo() {
  tempoTexto.textContent = `‚è≥ ${tempoRestante.toFixed(1)}s`;
  tempoBarra.style.width = `${(tempoRestante / tempoBase) * 100}%`;
}

function mostrarPergunta(texto) {
  perguntaEl.style.opacity = 0;
  setTimeout(() => {
    perguntaEl.textContent = texto;
    perguntaEl.style.opacity = 1;
  }, 250);
}

async function enviarResposta() {
  if (!jogoAtivo) return;
  tempoUltimaAtividade = Date.now();
  const resposta = campoResposta.value.trim();
  if (!resposta) return;

  const formData = new FormData();
  formData.append("tentativa", resposta);
  const res = await fetch("/responder", { method: "POST", body: formData });
  const data = await res.json();
  processarResposta(data, resposta);
}

function processarResposta(data, resposta) {
  if (data.fim)
    return fimDeJogo(data.mensagem, data.pontuacao_final, data.expressao);

  // ü©∏ Verifica se o backend liberou o modo PESADELO
  verificarModoPesadelo(data);

  if (data.modo_pesadelo_opcao) {
    modoPesadelo = true;
    falar("üòà Modo PESADELO ativado!");
    animarLuiz("anim-irritado", "üëø");
    tempoBase = 5; tempoRestante = 5;
  } else {
    falar(data.mensagem);
    if (data.acertou || resposta.toLowerCase() === "te amo") {
      animarLuiz("anim-feliz", "üòÅ");
      const bonus = Math.max(1, 5 - Math.floor(nivelAtual / 3));
      tempoRestante = Math.min(tempoRestante + bonus, tempoBase);
    } else {
      animarLuiz("anim-irritado", "üò†");
    }
  }

  pontuacaoAtual = data.pontos || pontuacaoAtual;
  nivelAtual = data.nivel || nivelAtual;
  pontosDisplay.textContent = pontuacaoAtual;
  nivelDisplay.textContent = nivelAtual;

  if (data.nova_pergunta) {
    mostrarPergunta(data.nova_pergunta);
    perguntaAtual = data.nova_pergunta;
  }

  if (!modoPesadelo)
    tempoBase = Math.max(10, 30 - nivelAtual * 1.3);
  campoResposta.value = "";
}

// üòà Fun√ß√£o de ativa√ß√£o do modo pesadelo
function verificarModoPesadelo(resposta) {
  if (resposta.modo_pesadelo_opcao) {
    const container = document.getElementById("pesadelo-container");
    if (container) {
      container.innerHTML = `
        <div class="alerta-pesadelo">
          <h3>‚ò†Ô∏è MODO PESADELO DISPON√çVEL!</h3>
          <p>Voc√™ provou seu valor... deseja desafiar o imposs√≠vel?</p>
          <button id="entrarPesadeloBtn" class="botao-pesadelo">Entrar no PESADELO</button>
        </div>
      `;
      document.getElementById("entrarPesadeloBtn").addEventListener("click", confirmarModoPesadelo);
    }
  }
}

// üî• Confirmar modo pesadelo
function confirmarModoPesadelo() {
  fetch("/confirmar_pesadelo", { method: "POST" })
    .then(res => res.json())
    .then(dados => {
      const container = document.getElementById("pesadelo-container");
      if (container) container.innerHTML = "";
      if (dados.mensagem) alert(dados.mensagem);
      if (dados.pergunta) mostrarPergunta(dados.pergunta);
    })
    .catch(err => console.error("Erro ao ativar modo pesadelo:", err));
}

function fimDeJogo(mensagem, pontuacao, expressao) {
  jogoAtivo = false;
  clearInterval(temporizador);
  clearInterval(humorTimer);
  falar(mensagem);
  expressaoLuiz.textContent = expressao;
  telaJogo.style.display = "none";
  telaGameover.style.display = "flex";
  document.getElementById("texto-fim").textContent = `Sua pontua√ß√£o: ${pontuacao}`;
  carregarRanking();
}

async function carregarRanking() {
  const res = await fetch("/ranking");
  const data = await res.json();
  const ranking = document.getElementById("ranking");
  ranking.innerHTML = "<h3>üèÜ Ranking Global</h3>";
  data.slice(0, 10).forEach(([nome, pontos], i) => {
    const item = document.createElement("div");
    item.textContent = `${i + 1}. ${nome}: ${pontos} pts`;
    ranking.appendChild(item);
  });
}

// === Humor e Expectativa do Luiz ===
function iniciarHumorLuiz() {
  clearInterval(humorTimer);
  humorTimer = setInterval(() => {
    if (!jogoAtivo) return;
    const tempoSemA√ß√£o = (Date.now() - tempoUltimaAtividade) / 1000;
    if (tempoSemA√ß√£o > 3 && tempoSemA√ß√£o < 6) {
      expressaoLuiz.textContent = "ü§î";
      animarLuiz("anim-curioso");
      falar("Hmm... pensando bem? üòè");
    } else if (tempoSemA√ß√£o >= 6 && tempoSemA√ß√£o < 10) {
      expressaoLuiz.textContent = "üòê";
      animarLuiz("anim-expectativa");
      falar("T√¥ esperando, viu...");
    } else if (tempoSemA√ß√£o >= 10) {
      expressaoLuiz.textContent = "üòí";
      animarLuiz("anim-irritado");
      falar("Vai demorar muito? üò§");
    }
  }, 2000);
}

document.getElementById("btn-iniciar").addEventListener("click", iniciarJogo);
botaoResponder.addEventListener("click", enviarResposta);
campoResposta.addEventListener("keydown", (e) => { if (e.key === "Enter") enviarResposta(); tempoUltimaAtividade = Date.now(); });
document.getElementById("btn-reiniciar").addEventListener("click", () => location.reload());
</script>
</body>
</html>
